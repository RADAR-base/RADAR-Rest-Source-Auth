<app-message *ngIf="error" [message]="error"></app-message>
<div class="container" >
  <div class="filter-container">
    <ng-container *ngTemplateOutlet="filtersContainer"></ng-container>
  </div>
  <button mat-mini-fab class="mini-fab-filters" color="primary" (click)="openTemplateSheetMenu()"><mat-icon>filter_list</mat-icon></button>
  <ng-template let-bottomSheetRef="bottomSheetRef" #templateBottomSheet>
    <div class="mobile-filter-container">
      <ng-container *ngTemplateOutlet="filtersContainer"></ng-container>
    </div>
  </ng-template>
  <div class="table-container">
    <table class="full-width-table"
           mat-table
           matSort
           [dataSource]="dataSource"
           aria-label="Users List">

      <ng-container matColumnDef="userId">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="m-w-150 ellipsis">{{'ADMIN.GENERAL.userId' | translate}}</th>
        <td mat-cell *matCellDef="let user" class="m-w-150 ellipsis">
          {{user.userId}}
        </td>
      </ng-container>

      <ng-container matColumnDef="externalId" class="m-w-100 ellipsis">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="m-hide m-w-100 ellipsis">{{'ADMIN.GENERAL.externalId' | translate}}</th>
        <td mat-cell *matCellDef="let user" class="m-hide m-w-100 ellipsis"> {{user.externalId}} </td>
      </ng-container>

      <ng-container matColumnDef="sourceType" class="m-w-100 ellipsis">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="m-hide m-w-100 ellipsis">{{'ADMIN.GENERAL.sourceType' | translate}}</th>
        <td mat-cell *matCellDef="let user" class="m-hide m-w-100 ellipsis"> {{user.sourceType}} </td>
      </ng-container>

      <ng-container matColumnDef="startDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="t-hide">{{'ADMIN.GENERAL.startDate' | translate}}</th>
        <td mat-cell *matCellDef="let user" class="t-hide"> {{(user.startDate | date:'dd/MM/y') || '-'}} </td>
      </ng-container>

      <ng-container matColumnDef="endDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="t-hide">{{'ADMIN.GENERAL.endDate' | translate}}</th>
        <td mat-cell *matCellDef="let user" class="t-hide"> {{(user.endDate | date:'dd/MM/y') || '-'}} </td>
      </ng-container>

      <ng-container matColumnDef="isAuthorized">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="m-hide m-w-220">{{'ADMIN.GENERAL.authorized' | translate}}</th>
        <td mat-cell *matCellDef="let user" class="m-hide m-w-220">
          <span *ngIf="user.isAuthorized" class="tag tag-success">
            {{ 'ADMIN.GENERAL.yes' | translate }}
          </span>
          <span *ngIf="!user.isAuthorized && user.registrationCreatedAt" class="tag tag-info">
            {{ 'ADMIN.GENERAL.pending' | translate }} ({{user.registrationCreatedAt | date:'dd/MM/y HH:mm:ss'}})
          </span>
          <span *ngIf="!user.isAuthorized && !user.registrationCreatedAt && user.id" class="tag tag-error">
            {{ 'ADMIN.GENERAL.no' | translate }}
          </span>
          <span *ngIf="!user.isAuthorized && !user.registrationCreatedAt && !user.id" class="tag tag-warn">
            {{ 'ADMIN.GENERAL.unset' | translate }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef style="text-align: end; width:80px;">{{'ADMIN.USERS_LIST.actions' | translate}}</th>
        <td mat-cell *matCellDef="let user" style="text-align: end; width:80px;">
          <button  mat-icon-button color="primary" (click)="openSubjectDialog('edit', user)">
            <mat-icon>edit</mat-icon>
          </button>
          <button *ngIf="!user.isAuthorized" mat-icon-button color="primary" (click)="openSubjectDialog('edit', user)">
            <mat-icon>add_link</mat-icon>
          </button>
            <button *ngIf="user.isAuthorized" mat-icon-button color="warn" (click)="openSubjectDialog('delete', user)" >
            <mat-icon>link_off</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let rowData; columns: displayedColumns"></tr>

      <!-- Row shown when there is no matching data. -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="8">{{'ADMIN.USERS_LIST.noData' | translate}}</td>
      </tr>
    </table>
  </div>
  <mat-paginator [pageSize]="5" [pageSizeOptions]="[2, 5, 10]" aria-label="Select page of users"></mat-paginator>
</div>

<ng-template #filtersContainer>
  <div>
    <mat-form-field *ngFor="let filter of filters"
                    class="form-field"
                    [style]="'width: '+ filter.width +'px; max-width: 100%;'"
                    appearance="outline">
      <mat-label>{{filter.name | translate}}</mat-label>
      <mat-select *ngIf="filter.type == 'select'"
                  name="{{filter.columnProp}}"
                  [(ngModel)]="filter.modelValue"
                  (selectionChange)="filterChange(filter, $event)">
        <mat-option value="">{{'ADMIN.GENERAL.all' | translate}}</mat-option>
        <mat-option *ngFor="let item of filter.options" [value]="item.value" >{{item.label | translate}}</mat-option>
      </mat-select>
      <input *ngIf="filter.type == 'input'"
             matInput
             name="{{filter.columnProp}}"
             [(ngModel)]="filter.modelValue"
             (keyup)="filterChange(filter, $event.target)">
    </mat-form-field>
  </div>
  <button mat-raised-button
          color="warn"
          class="reset-filters"
          (click)="resetFilters()">
    {{'ADMIN.USERS_LIST.filters.clearFilters' | translate}}
  </button>
</ng-template>
